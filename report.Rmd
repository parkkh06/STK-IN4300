---
title: "STK-IN4300"
author: "Kyunhee Park"
date: "2024-09-11"
output: html_document
---

```{r setup, include=FALSE}
library(magrittr)
library(here)
# Data load and process
knitr::opts_chunk$set(echo = TRUE)

data_raw <- read.csv(here("data/SeoulBikeData.csv"), fileEncoding = "UTF-8")

data <- data_raw %>% dplyr::filter(Functioning.Day == "Yes") %>%                # filter out invalid data
  dplyr::select(-Functioning.Day)                                           # drop unnecessary col

data$Seasons <- as.factor(data$Seasons) # categorical variable: factorize
data$Holiday <- as.factor(data$Holiday) # categorical variable: factorize

#data_encoded <- data %>% 
#  dplyr::mutate(value = 1) %>% tidyr::spread(Seasons, value, fill = 0) %>%  
#  dplyr::mutate(Holiday = ifelse(Holiday ==  "No Holiday", 0, 1))

#source(paste0(getwd(), "/script.R"))
```
# 1. Summary Statistics Table
Summarizes the information in the data on a variable level.

## 1.1 Raw data summary table.

The table below shows the summary table of raw data, before conducting preprocessing.
```{r variables, echo=FALSE}
summary(data_raw)
```
### 1.1.1 Target variable
- Rented.Bike.Count: Target variable

### 1.1.2 Categorical variables

- Date: Date in sequence, will be replaced by another columns, "id", which is the row number.
- Seasons: Autumn, Winter, Spring, Summer -> Transform to a factor variable, by applying as.factor()
- Holiday: No Holiday, Holiday -> Transform to a factor variable, by applying as.factor()
- Functioning.Day: Yes, No -> "No" rows will be filtered out, as no additional information is obtainable.

### 1.1.3 Continous variables
- Temperature
- Humidity
- Wind.speed
- Visibility
- Dew.point.temperature
- Solar.Radiation
- Rainfall
- Snowfall

Continous variables will be to be scaled.


## 1.2 Processed data summary table.

The table below shows the summary table of preprocessed dataset.
```{r summary, echo=FALSE}
summary(data)
```

# 2. Bad Data Visualization

For at least one categorical and one continuous variable in your data, make a bad plot and explain why it is bad and possibly even misleading.

## 2.1 Bad Data Visualization - Categorical variable

- X axis: Holiday/No Holiday
- Y axis: Average Rented.Bike.Count

```{r 2.1-categorical, echo=FALSE}
ggplot2::ggplot(data %>%
                  dplyr::group_by(Holiday) %>%
                  dplyr::summarise(
                    avg_rent = mean(Rented.Bike.Count)), 
                ggplot2::aes(x = Holiday, y = avg_rent, fill = Holiday)) + 
  ggplot2::geom_bar(stat = "identity") + 
  ggplot2::labs(x = "Holiday", y = "Average rented bike")
```
- Does not provide information regarding seasonal effect.
- Lack of information regarding distribution - Quantile, Median, Min, Max


## 2.2 Bad Data Visualization - Continous variable

- X axis: Hour, 0 ~ 23
- Y axis: Rented.Bike.Count

```{r 2.2-continous, echo=FALSE}

ggplot2::ggplot(data = data,
  ggplot2::aes(x = Hour, y = Rented.Bike.Count)) + 
  ggplot2::geom_line()
```
- Does not include seasonal effect.
- Hour variable repeats everyday, needs to be grouped.


# 3. Good Data Visualization
Provide a good version of the bad plot(s) from Problem 2 and explain how the plot has been improved.

## 3.1 Good Data Visualization - Categorical variable

### 3.1.1 Improvements
- Include seasonal effect.
- Provide distribution of the bike rentals.

```{r 3.1-categorical, echo=FALSE}
ggplot2::ggplot(data,
                ggplot2::aes(x = Seasons, y = Rented.Bike.Count, fill = Holiday)) + 
  ggplot2::geom_boxplot() + 
  ggplot2::facet_wrap(~ Holiday)
```
### 3.1.2 Interpretation
- No Holiday has overall higher demands.
- Normal observations are similar in both on Holiday/No Holiday.
- More frequent extreme values in No Holiday, likely to be during the rush-hour.


## 3.2 Good Data Visualization - Continous variable

### 3.1.1 Improvements

- Grouped by Seasons to demonstrate seasonal effect.
```{r 3.2-continous, echo=FALSE}
ggplot2::ggplot(data = data %>% 
                  dplyr::group_by(Hour, Seasons) %>% 
                  dplyr::summarize(Average_rented_bike = mean(Rented.Bike.Count)),
                ggplot2::aes(x = Hour, y = Average_rented_bike, group = Seasons)) + 
  ggplot2::geom_line(ggplot2::aes(color = Seasons), size = 1) + 
  ggplot2::geom_point(color = "grey", size = 0.7)
```
### 3.2.1 Interpretations
- Reaches peak during the rush hour, 8-9AM, 18-19PM.
- 

# 4. Simple analysis

Perform linear regression on the data, including some method for performing model selection. 
Include some measure of performance on the final model.
Based both on the analysis and your previous visualizations, evaluate whether a linear model is sufficient.
```{r mdl_train, include=FALSE}

data$id <- 1:nrow(data)      # unique key id

train_set <- data %>% dplyr::sample_frac(0.8)



test_set <- dplyr::anti_join(data, train_set, by = 'id')

# colnames(train_set)

mlr_model <- lm(Rented.Bike.Count ~ Hour + Temperature.C. + Humidity... + Wind.speed..m.s. + Visibility..10m. + Dew.point.temperature.C. + Solar.Radiation..MJ.m2. + Rainfall.mm. + Snowfall..cm. + Seasons + Holiday, data = train_set)

glm_model <- glm(Rented.Bike.Count ~ Hour + Temperature.C. + Humidity... + Wind.speed..m.s. + Visibility..10m. + Dew.point.temperature.C. + Solar.Radiation..MJ.m2. + Rainfall.mm. + Snowfall..cm. + Seasons + Holiday, 
                 family = poisson(link = "log"), 
                 data = train_set)


summary(mlr_model)

plot(mlr_model)

prediction_mlr <- predict(mlr_model, newdata = test_set)

prediction_glm <- predict(glm_model, newdata = test_set)

prediction_mlr_df <- data.frame(prediction_mlr)

test_set_baseline <-  test_set %>% dplyr::select(id, Date, Hour, Rented.Bike.Count)

merged_df_test_set <- cbind(test_set_baseline, prediction_mlr_df)
```

# 5. Analysis assessment
- Time series data, seasonal effect and Date column are not considered.
- Hour is important - obvious that it moves based on the time. Peaks at rush hour.

