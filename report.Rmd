---
title: "STK-IN4300"
author: "Kyunhee Park"
date: "2024-09-11"
output: html_document
---

```{r setup, include=FALSE}
library(magrittr)
library(here)
# Data load and process
knitr::opts_chunk$set(echo = TRUE)

data_raw <- read.csv(here("data/SeoulBikeData.csv"), fileEncoding = "UTF-8")

data <- data_raw %>% dplyr::filter(Functioning.Day == "Yes") %>%                # filter out invalid data
  dplyr::select(-Functioning.Day)                                           # drop unnecessary col

data$Seasons <- as.factor(data$Seasons) # categorical variable: factorize
data$Holiday <- as.factor(data$Holiday) # categorical variable: factorize

#data_encoded <- data %>% 
#  dplyr::mutate(value = 1) %>% tidyr::spread(Seasons, value, fill = 0) %>%  
#  dplyr::mutate(Holiday = ifelse(Holiday ==  "No Holiday", 0, 1))

#source(paste0(getwd(), "/script.R"))
```
# 1. Summary Statistics Table
Summarizes the information in the data on a variable level.

## 1.1 Raw data summary table.

The table below shows the summary table of raw data, before conducting preprocessing.
```{r variables, echo=FALSE}
summary(data_raw)
```
### 1.1.1 Target variable
- Rented.Bike.Count: Target variable

### 1.1.2 Categorical variables

- Date: Date in sequence, will be replaced by another columns, "id", which is the row number.
- Seasons: Autumn, Winter, Spring, Summer -> Transform to a factor variable, by applying as.factor()
- Holiday: No Holiday, Holiday -> Transform to a factor variable, by applying as.factor()
- Functioning.Day: Yes, No -> "No" rows will be filtered out, as no additional information is obtainable.

### 1.1.3 Continous variables
- Temperature
- Humidity
- Wind.speed
- Visibility
- Dew.point.temperature
- Solar.Radiation
- Rainfall
- Snowfall

Continous variables will be to be scaled.


## 1.2 Processed data summary table.

The table below shows the summary table of preprocessed dataset.
```{r summary, echo=FALSE}
summary(data)
```

# 2. Bad Data Visualization

For at least one categorical and one continuous variable in your data, make a bad plot and explain why it is bad and possibly even misleading.

## 2.1 Bad Data Visualization - Categorical variable

The boxplot below shows the number of holidays in 4 different seasons (Autumn, Spring, Summer, Winter).
```{r 2.1-categorical, echo=FALSE}
ggplot2::ggplot(data %>%
                  dplyr::group_by(Holiday) %>%
                  dplyr::summarise(
                    avg_rent = mean(Rented.Bike.Count)), 
                ggplot2::aes(x = Holiday, y = avg_rent)) + 
  ggplot2::geom_bar(stat = "identity")

ggplot2::ggplot(data %>%
                  dplyr::group_by(Holiday) %>%
                  dplyr::summarise(
                    avg_rent = mean(Rented.Bike.Count)), 
                ggplot2::aes(x = Holiday, y = avg_rent)) + 
  ggplot2::geom_bar(stat = "identity")


ggplot2::ggplot(data,
                ggplot2::aes(x = Seasons, fill = Holiday)) + 
  ggplot2::geom_bar(stat = "count", position = "stack") + 
  ggplot2::geom_line(aes())


ggplot2::ggplot(data) +
  ggplot2::geom_bar(ggplot2::aes(x = Seasons, fill = Holiday), stat = "count", position = "stack") + 
  ggplot2::geom_line(ggplot2::aes(x = Seasons, y = Rented.Bike.Count), stat = "identity", color = "red")


data %>% dplyr::group_by(Seasons, Holiday) %>% dplyr::summarize(CNT = dplyr::n(), Avg_rent = mean(Rented.Bike.Count))

ggplot2::ggplot(data %>% dplyr::group_by(Seasons) %>% dplyr::summarize(Rented.Bike.Count = mean(Rented.Bike.Count))) + 
  ggplot2::geom_line(ggplot2::aes(x = Seasons, y = Rented.Bike.Count, group = 1))

ggplot2::ggplot(data %>% dplyr::group_by(Seasons, Holiday) %>% dplyr::summarize(CNT = dplyr::n(), Avg_rent = mean(Rented.Bike.Count))) + 
  ggplot2::geom_line(ggplot2::aes(x = Seasons, y = Avg_rent), group = 1)
  
  
  ggplot2::geom_bar(ggplot2::aes(x = Seasons, fill = Holiday), position = "dodge")

```

## 2.2 Bad Data Visualization - Continous variable

The figure below shows the trend of bike usage throughout the timeline. The dataset contains seasonal time-series data. However, just simply providing time-series data for entire period does not provide any insights. Therefore, this graph can be modified in a more concise manner.
```{r 2.2-continous, echo=FALSE}
ggplot2::ggplot(data = data,
  ggplot2::aes(x = Date, y = Rented.Bike.Count, group = 1)) + 
  ggplot2::geom_line(color = "blue", size = 1) +
  ggplot2::geom_point(size = 1)


ggplot2::ggplot(data = data,
  ggplot2::aes(x = Rainfall.mm., y = Rented.Bike.Count)) + 
  ggplot2::geom_line()

ggplot2::ggplot(data = data,
  ggplot2::aes(y = Rented.Bike.Count)) + 
  ggplot2::geom_bar()

ggplot2::ggplot(data = data,
  ggplot2::aes(x = Temperature.C., y = Rented.Bike.Count, group = 1)) + 
  ggplot2::geom_line(color = "blue", size = 1) +
  ggplot2::geom_point(size = 1)

ggplot2::ggplot(data = data,
  ggplot2::aes(x = Rented.Bike.Count, y = Hour)) + 
  ggplot2::geom_line()


ggplot2::ggplot(data, ggplot2::aes(x = Temperature.C.)) + 
  ggplot2::geom_histogram()
```

# 3. Good Data Visualization
Provide a good version of the bad plot(s) from Problem 2 and explain how the plot has been improved.

## 3.1 Good Data Visualization - Categorical variable

```{r 3.1-categorical, echo=FALSE}
ggplot2::ggplot(data,
                ggplot2::aes(x = Seasons, y = Rented.Bike.Count, fill = Holiday)) + 
  ggplot2::geom_boxplot() + 
  ggplot2::facet_wrap(~ Holiday)

```
## 3.1 Good Data Visualization - Continous variable


```{r 3.2-continous, echo=FALSE}
Hourly_avg <- data %>%
  dplyr::group_by(Hour) %>%
  dplyr::summarize(Average_rented_bike = mean(Rented.Bike.Count))

Hourly_avg <- data %>%
  dplyr::group_by(Hour, Seasons) %>%
  dplyr::summarize(Average_rented_bike = mean(Rented.Bike.Count))


ggplot2::ggplot(data = data %>% dplyr::group_by(Hour, Seasons) %>% dplyr::summarize(Avg_rented_bike = mean(Rented.Bike.Count)),
                ggplot2::aes(x = Hour, y = Avg_rented_bike, group = Seasons)) + 
  ggplot2::geom_line(ggplot2::aes(color = Seasons), size = 1) + 
  ggplot2::geom_point(color = "black", size = 0.7) + 
  ggplot2::labs(x = "Time: 12AM-23PM", y = "Average Rented count")
  
  
  ggplot2::scale_color_manual(name = "Seaons", values = c("Autumn" = "red", "Winter" = "blue", "Spring" = "yellow", "Summer" = "green"))

ggplot2::ggplot(data = Hourly_avg,
  ggplot2::aes(x = Hour, y = Average_rented_bike, group = 1)) + 
  ggplot2::geom_line(color = "blue") +
  ggplot2::geom_point()

```

# 4. Simple analysis

Perform linear regression on the data, including some method for performing model selection.

Include some measure of performance on the final model.

Based both on the analysis and your previous visualizations, evaluate whether a linear model is sufficient.
```{r mdl_train, include=FALSE}

data$id <- 1:nrow(data)      # unique key id
train_set <- data %>% dplyr::sample_frac(0.8)

test_set <- dplyr::anti_join(data, train_set, by = 'id')

# colnames(train_set)

mlr_model <- lm(Rented.Bike.Count ~ Hour + Temperature.C. + Humidity... + Wind.speed..m.s. + Visibility..10m. + Dew.point.temperature.C. + Solar.Radiation..MJ.m2. + Rainfall.mm. + Snowfall..cm. + Seasons + Holiday, data = train_set)

glm_model <- glm(Rented.Bike.Count ~ Hour + Temperature.C. + Humidity... + Wind.speed..m.s. + Visibility..10m. + Dew.point.temperature.C. + Solar.Radiation..MJ.m2. + Rainfall.mm. + Snowfall..cm. + Seasons + Holiday, 
                 family = poisson(link = "log"), 
                 data = train_set)


summary(mlr_model)

plot(mlr_model)

prediction_mlr <- predict(mlr_model, newdata = test_set)

prediction_glm <- predict(glm_model, newdata = test_set)

prediction_mlr_df <- data.frame(prediction_mlr)

test_set_baseline <-  test_set %>% dplyr::select(id, Date, Hour, Rented.Bike.Count)

merged_df_test_set <- cbind(test_set_baseline, prediction_mlr_df)


```

